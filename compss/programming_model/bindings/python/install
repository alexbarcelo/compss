#!/bin/bash

  #
  # SCRIPT GLOBAL CONSTANTS
  #

  SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


  #
  # SCRIPT GLOBAL HELPERS
  #

  # shellcheck source=./commons
  # shellcheck disable=SC1091
  source "${SCRIPT_DIR}"/commons


  #
  # HELPER FUNCTIONS
  #

  command_exists () {
    type "$1" &> /dev/null ;
  }

  clean() {
    rm -rf "${SCRIPT_DIR}"/build
  }

  # It is possible to install Python3 version within the same folder (python code is compatible), but:
  #   - The extensions have different names, so that the most appropriate can be selected dynamically.
  #   - pyc and pyo files are in different folders (for python2 within the same as .py files, while
  #     in python 3 they are within __pycache__ folder).
  # However, we keep them in different folders with the python major version as subfolder.
  install () {
    local python_version=$1
    local python_command="python${python_version}"
    local python_complete_version
    local python_collapsed_version

    PYCOMPSS_HOME="${targetDir}/${python_version}"
    export PYTHONPATH=$PYCOMPSS_HOME:$OLD_PYTHONPATH
    #export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-armhf

    if command_exists "${python_command}" ; then
      echo "INFO: Installing PyCOMPSs for ${python_command}"

      # Check that the python version used is higher than 2.6.
      python_complete_version=$(${python_command} -V 2>&1)
      python_collapsed_version=$(echo "${python_complete_version}" | sed 's/.* \([0-9]\).\([0-9]\).*/\1\2/')
      if [ "${python_collapsed_version}" -lt "27" ]; then
        echo "ERROR: Cannot install PyCOMPSs for Python version: ${python_complete_version}"
        echo "       PyCOMPSs requires python 2.7 or greater"
        exit 1
      fi

      # Check that the sources can be byte-compiled - this avoids syntax errors
      # that are not checked on the installation
      ${python_command} -m compileall "${SCRIPT_DIR}"/src/pycompss
      exitCode=$?
      if [ $exitCode -ne 0 ]; then
        echo "ERROR: Cannot install PyCOMPSs for Python ${python_version} - Could not byte-compile."
        exit $exitCode
      fi

      # Check whether the dependency module is required
      shma_test_script="${SHAREDARRAY_HOME}"/shma_test_required.py
      ${python_command} "${shma_test_script}"
      exitCode=$?
      if [ $exitCode -ne 0 ]; then
        need_shma=1
        # Shared Array is either not installed or not the right version.
        # We need to install the dependency.
        shmaTargetDir="$( dirname $( dirname "${targetDir}" ) )"/Dependencies/SharedArray
        export PYTHONPATH="${shmaTargetDir}":$PYTHONPATH
        ${python_command} "${SHAREDARRAY_HOME}"/setup.py    \
          build_ext   -b "${SHAREDARRAY_HOME}"/build  \
          install_lib -b "${SHAREDARRAY_HOME}"/build  \
                      --install-dir="${shmaTargetDir}"
        exitCode=$?
        if [ $exitCode -ne 0 ]; then
          echo "ERROR: Failed to install Shared Array required dependency."
          exit $exitCode
        fi
        cat > "${shmaTargetDir}"/__init__.py <<EOF
#!/usr/bin/python
#
#  Copyright 2019      Cray UK Ltd., a Hewlett Packard Enterprise company
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

# -*- coding: utf-8 -*-
EOF
        exitCode=$?
        if [ $exitCode -ne 0 ]; then
          echo "ERROR: Failed to create __init__.py file required for Shared Array module."
          exit $exitCode
        fi
      else
        need_shma=0
        echo "Already installed for current python version. Skip."
      fi

      # Do the installation
      ${python_command} "${SCRIPT_DIR}"/setup.py install --install-lib="${PYCOMPSS_HOME}" -O2
      exitCode=$?
      if [ $exitCode -ne 0 ]; then
        echo "ERROR: Cannot install PyCOMPSs for Python ${python_version}"
        exit $exitCode
      fi

      # Link to the dependencies so we find them in the pythonpath at runtime.
      if [ $need_shma -gt 0 ]; then
        ln -sfn "${shmaTargetDir}" "${PYCOMPSS_HOME}"
        exitCode=$?
        if [ $exitCode -ne 0 ]; then
          echo "ERROR: Failed to create link to Shared Array dependency installation directory."
          exit $exitCode
        fi
      fi

      # Unify installed versions
      if [ "${python_version}" == "3" ] && [ -d "${targetDir}/2" ] && [ "$unify_installs" = "true" ]; then
        unify_installed_versions "${targetDir}"
      fi
      if [ "$create_symlinks" = "true" ]; then
        # Expected when installing with buildlocal. Not from buildsc.
        # Pip package sets these symbolic links and updates the 'activate' script accordingly.
        create_symbolic_links "${python_version}" "${PYCOMPSS_HOME}"
      fi
    else
      echo "ERROR! ${python_command} IS NOT AVAILABLE."
      exit 1
    fi
  }


  #
  # MAIN
  #

  # Retrieve script arguments
  targetDir=$1            # Target directory where to install the python binding.
  create_symlinks=$2      # true or false. Create symbolic links within site/dist-packages folders.
  unify_installs=$3       # true or false. Remove sources from 3 and link to 2 if exists.
  only_python_version=$4  # Optional argument

  # Add trap for clean
  trap clean EXIT

  # Install
  OLD_PYTHONPATH=$PYTHONPATH

  if [ -z "$only_python_version" ]; then
    # Try to install all
    # Check $targetDir = site-packages usual, dist-packages in deb based distributions.
    if [[ "$targetDir" = *site-packages* ]] || [[ "$targetDir" = *dist-packages* ]]; then
      # If it is within site-packages, install only the appropriate version.
      if [[ "$targetDir" = *python2* ]]; then
        echo "* Installing python 2 version."
        # within 2.X site-packages
        install 2
      elif [[ "$targetDir" = *python3* ]]; then
        echo "* Installing python 3 version."
        # within 3.X site-packages
        install 3
      else
        echo "ERROR! UNSUPPORTED TARGET DIRECTORY WITHIN site-packages OR dist-packages."
        exit 1
      fi
    else
      # Install all
      install 2
      install 3
    fi
  elif [ "$only_python_version" == "python2" ]; then
    echo "* Installing JUST python 2 version."
    # Install only python 2 version
    install 2
  elif [ "$only_python_version" == "python3" ]; then
    echo "* Installing JUST python 3 version."
    # Install only python 3 version
    install 3
  else
    echo "ERROR! UNSUPPORTED PYTHON VERSION."
    exit 1
  fi

  # Copy cleaning and commons scripts for setup or uninstalling
  cp "${SCRIPT_DIR}/commons" "$targetDir"
  cp "${SCRIPT_DIR}/clean" "$targetDir"

  # Normal exit
  exit 0
